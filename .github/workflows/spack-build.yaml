name: spack build test

on:
  push:
    paths-ignore:
      - '*.md'
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - edited
    paths-ignore:
      - '*.md'
  workflow_dispatch:

jobs:
  test:
    strategy:
      matrix:
        uarch: [uarch-tx2, uarch-a64fx]
    runs-on: [self-hosted, ${{ matrix.node }}]

    steps:
      - name: Checkout repo to ./recipes ðŸ¥£
        uses: actions/checkout@v2
        with:
          path: ./recipes
          fetch-depth: 1

      - name: Checkout spack to ./spack ðŸ¥£
        uses: actions/checkout@v2
        with:
          repository: spack/spack
          ref: develop
          path: ./spack
          fetch-depth: 1

      - name: Prepare Spack ðŸ›’
        run: |
          source spack/share/spack/setup-env.sh
          spack compiler find
          spack compilers
          spack find -lvvx

      - name: Build ðŸ”¨
        run: |
            source spack/share/spack/setup-env.sh
            for FILE in ./recipes/specs/*; do
              while IFS='' read -r LINE || [ -n "${LINE}" ]; do
                spack install --fail-fast ${LINE}
              done < ${FILE}
            done
